const postModel = require('../model/post.model')
const ImageKit = require("@imagekit/nodejs")
const { toFile } = require("@imagekit/nodejs")
const jwt = require("jsonwebtoken")

async function postCreation(req,res){

   

    
    const imageKit = new ImageKit({
  privateKey: process.env['IMAGEKIT_KEY'], //give api key
});
     const token = req.cookies.token //taking token from cookies
     console.log(token)
     if(!token){
      return res.stauts(401).json({    //if not toke then this
            message:"Unauthorized access"
        })
     }
     let decoded ;
     try{
        decoded = jwt.verify(token, process.env.JWT_SECRET)
     }catch(error){
        return res.status(401).json({
            message: "user not authorized"
        })
    }
     

const file = await imageKit.files.upload({
        file: await toFile(Buffer.from(req.file.buffer), 'file'),
        fileName: "Test",
        folder: "cohort-2-insta-clone-posts"
    })
    console.log(file)

    const post = await postModel.create({
        caption:req.body.caption,
        imageUrl:file.url,       //uploading post detail to database
        userId:decoded.id
    })
   res.status(201).json({
    message:"Post uploaded"
   })

}

//getting post of the user
async function getPosts(req,res){
    const token = req.cookies.token; //taking token
    if(!token){
        res.status(401).json({
            Message:"Unauthorized access"  //if not token then this...
        })
    }
    let verify;
    try{
        verify = jwt.verify(token, process.env.JWT_SECRET);  //Verifying the token if generated by user
    }catch(error){
        res.status(401).json({
            Message:"Token invalid"
        })
    }
   
    const id = verify.id
    const posts = await postModel.find({userId:id})  //find all data who contain this userId
    res.status(200).json({
        message:"Post fetch",
        posts
    })  
}
// postdetail api
 async function detailPost(req, res){
   const postId = req.params.postId; //endpoint, dynamic postId

   const token = req.cookies.token;
   if(!token){
   return res.status(401).json({
        message:"Unautorized access"
    })
   }
   let verifyToken
   try{
   verifyToken = jwt.verify(token, process.env.JWT_SECRET)
   }catch(error){
    res.status(401).json({
        message:"Not valid token"
    })
   }
   const post = await postModel.findById(postId)
   

   const checkUserCorrect = verifyToken.id == post.userId.toString()
   if(!checkUserCorrect)
   {
    res.status(401).json({
        Message:"Post not found"
    })
   }
   res.status(200).json({
    Message:"Here is your post",
    post

   })


 }
module.exports = {postCreation,getPosts,detailPost};